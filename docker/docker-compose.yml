version: '3.8'

services:
  redis:
    image: redis:6-alpine
    container_name: redis
    networks:
      qkd_network:
        ipv4_address: 172.18.0.2
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  directory-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.directory
    container_name: directory-service
    volumes:
      - ../src:/app/src
    ports:
      - "5000:5000"
    networks:
      qkd_network:
        ipv4_address: 172.18.0.10

  # --- QKD NODES (Running Stack + Proxy) ---
  node-a:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: node-a
    # COMMAND: Run the Proxy in background (&) then keep the container alive (or run QKD stack)
    volumes:
      - ./node-a/.qkd:/root/.qkd
      - ../src:/app/src
    environment:
      - KMS_URL=http://localhost:8095  # Internal KMS
      - TARGET_IP=172.18.0.4
      - TARGET_PORT=10446
    networks:
      qkd_network:
        ipv4_address: 172.18.0.3
    depends_on:
      redis:
        condition: service_healthy

  node-b:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: node-b
    volumes:
      - ./node-b/.qkd:/root/.qkd
      - ../src:/app/src
    environment:
      - KMS_URL=http://localhost:8095 # Internal KMS
      - LISTEN_PORT=10446
      - PEER_SITE_ID=A
    networks:
      qkd_network:
        ipv4_address: 172.18.0.4
    depends_on:
      - redis
      - node-a

  # --- USER APPLICATIONS (The New Part) ---

  # Sender App (Talks to Node A Proxy)
  app-sender:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: app-sender
    volumes:
      - ../src:/app/src
      - ../data:/app/data # Assuming you have data here
    environment:
      - KMS_URL=http://node-a:5000
      - DIRECTORY_SERVICE_URL=http://172.18.0.10:5000
    command: tail -f /dev/null # Keep alive and dont run proxy
    networks:
      qkd_network:
        ipv4_address: 172.18.0.20
    depends_on:
      - node-a

  # Receiver App (Talks to Node B Proxy)
  app-receiver:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: app-receiver
    volumes:
      - ../src:/app/src
      - ../received_data:/app/received_data
    environment:
      # Point KMS_URL to Node B's Proxy
      - KMS_URL=http://node-b:5000
      - DIRECTORY_SERVICE_URL=http://172.18.0.10:5000
      - LISTEN_IP=0.0.0.0
      - LISTEN_PORT=12345
    command: tail -f /dev/null # Keep alive and dont run proxy
    networks:
      qkd_network:
        ipv4_address: 172.18.0.21
    depends_on:
      - node-b

networks:
  qkd_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16